---
title: 'Assignment 4: LobStars in the Santa Barbara Channel'
author: "Natalie Dornan, Daphne Virlar-Knight"
date: "November 13, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load packages and read in data

```{r, include=FALSE}

# install.packages("vcdExtra") Natalie installed new package
library(tidyverse)
library(kableExtra)
library(plotly)
library(vcdExtra)
library(magrittr)
library(car)

lobstar_abs <- read_csv("lobster_size_abundance.csv") #data frame with lobster abundance datac

lobstar_traps <- as.data.frame(read_csv("lobster_traps.csv")) # data frame with lobster trap data


```

Daphne: Created graphs for question 1, but not sure they're "complete enough".
Natalie: Added abundace summary tables

1. Lobster abundance and fishing pressure
```{r, echo=FALSE}
#-----------------------------------TABLE CREATIONS--------------------------------------
#Describe trends in lobster abundance (counts) and fishing pressure (trap buoys) at the five locations from 2012 - 2017. Ignore transect information - we are only interested in evaluating abundance and pressure on the order of SITE.

#getting rid of transect data, and changing -99999 to 0
lobstar_abs_one <- lobstar_abs %>% 
  select(-SBC_LTER_TRANSECT, -LOBSTER_TRANSECT) %>% 
  mutate(SIZE = replace(SIZE, SIZE==-99999, 0)) %>% 
  group_by(YEAR, SITE) %>% 
  summarize(
    SUM = sum(COUNT)
  )

#### Nice work Daphne! I'll create a new dataframe for potential summary table

lobstar_summary <- lobstar_abs %>% 
  select(-SBC_LTER_TRANSECT, -LOBSTER_TRANSECT) %>% 
  mutate(SIZE = replace(SIZE, SIZE==-99999, 0)) %>% 
  group_by(YEAR, SITE) %>% 
  summarize(
    mean_size = round(mean(SIZE),2),
    median_size = round(median(SIZE),2),
    max_size = round(max(SIZE),2),
    sd_size = round(sd(SIZE),2),
    total_observations = sum(COUNT),
    sample_size = length(SIZE))

## Summary tables by year. A table of all years was too long, so N split them up
##2012

lobstar_sum_table_12 <- lobstar_summary %>%
  filter(YEAR == "2012") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2012" = 8)) # add header above table columns

lobstar_sum_table_12

##2013

lobstar_sum_table_13 <- lobstar_summary %>%
  filter(YEAR == "2013") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2013" = 8)) # add header above table columns

lobstar_sum_table_13

##2014

lobstar_sum_table_14 <- lobstar_summary %>%
  filter(YEAR == "2014") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2014" = 8)) # add header above table columns

lobstar_sum_table_14

##2015

lobstar_sum_table_15 <- lobstar_summary %>%
  filter(YEAR == "2015") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2015" = 8)) # add header above table columns

lobstar_sum_table_15

##2016

lobstar_sum_table_16 <- lobstar_summary %>%
  filter(YEAR == "2016") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2016" = 8)) # add header above table columns

lobstar_sum_table_16

##2017

lobstar_sum_table_17 <- lobstar_summary %>%
  filter(YEAR == "2017") %>%
  kable(align = "c", col.names = c("Year", "Site", "Mean", "Median", "Maximum", "Standard Deviation", "# Lobstars Observed", "Sample Size (n)")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Lobster Abundance at Different Sites in the Santa Barbara Channel, 2017" = 8)) # add header above table columns

lobstar_sum_table_17


#Creating histograms of lobster abundance and fishing pressure by site. Maybe use a kable table to summarize information? Thinking out loud. ND: created tables by year. I think it's helpful, but may want to brainstorm best table visualization.

#the next two graphs show the same data and trend. Just need to decided which we want to use.

```



```{r}

#------------------------------EXPLORATORY DATA ANALYSIS---------------------------------
lobstar_abs_tidy <- lobstar_abs %>% 
  filter(COUNT != "0")


hist <- ggplot(lobstar_abs_tidy, aes(x=SIZE)) +
  geom_histogram() +
  facet_wrap(~ SITE)

qq_plot <- ggplot(lobstar_abs_tidy, aes(sample=SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

#everything's fine


```



```{r}
#-----------------------------ABUNDANCE AND TRAP PRESSURE--------------------------------

abs_site_scatter <- ggplot(lobstar_abs_one, aes(x = YEAR, y = SUM)) +
  geom_point() +
  geom_line(aes(col = SITE))+
  ggtitle("Abundance of Lobsters")+
  ylab("Count")+
  theme_classic()
abs_site_scatter


#Take out sites IVEE and NAPL
trap_pres_one <- lobstar_traps %>% 
  group_by(YEAR, SITE) %>% 
  summarize(
    SUM = sum(TRAPS)
  ) %>% 
  filter(SITE !="ABUR", SITE != "AHND to AQUE", SITE != "AHND", SITE != "GOLB", SITE != "NAPL")



trap_pres_scatter <- ggplot(trap_pres_one, aes(x = YEAR, y = SUM))+
  geom_point()+
  geom_line(aes(col = SITE))+
  theme_classic()+
  ggtitle("Fishing Pressure \n")+
  ylab("Trap Buoys")


trap_pres_scatter2 <-trap_pres_scatter + scale_colour_discrete(
                            breaks=c("AQUE", "CARP", "IVEE", "MOHK"),
                            labels=c("AQUE", "CARP", "IVEE & NAPL", "MOHK"))

trap_pres_scatter2
```

Natalie RE: graphs. I think for time series data using the scatter is a little easier to digest quickly, especially since we will be comparing abundance to pressure. If we were looking at multiple species then the bar graph would be better. Also, maybe for tables we should merge some data to show trap trends by site and year too. Thoughts? 

Daphne RE: graphs. 
        I think merging the data for abundance v traps as a table makes more sense than showing it in a graph. 
        Also, I think for all graphs we should export them and work on them in word or a google doc. Creating a a full on report in markdown sounds like more of a pain than it's worth. 



Question 2:
Lobstah carapace length (mm) in 2017
```{r}
# Create expanded dataframe of lobster carapace length in 2017

lobstah_body <- lobstar_abs_tidy %>%
  expand.dft(freq = "COUNT") %>%
  filter(YEAR == "2017")

## Levene's test for varience, can create kable table of this later

variences <- lobstah_body %>% 
  group_by(SITE) %>% 
  summarize(
    mean = mean(SIZE),
    sd = sd(SIZE),
    variance = var(SIZE)
  )

variences #Don't look that different

lobstar_var_table <- variences %>%
  kable(align = "c", col.names = c("Site", "Mean", "Standard Deviation", "Varience")) %>%
  kable_styling(bootstrap_options = c("striped", "consensed"), full_width = F) %>%
  add_header_above(c("Carapice Length (mm) of California Spiny Lobsters at 5 Locations in 2017" = 4)) # add header above table columns

lobstar_var_table

#Levene's test for equal variances (and keep in mind the general rule: if the greatest variances is < 4x bigger than the smallest variance, then usually those are "close enough" to assume equal variance)

lobstah_levene <- leveneTest(SIZE ~ SITE, data = lobstah_body)

lobstah_levene # Levenes test results

# ANOVA for testing means

lobstah_aov <- aov(SIZE ~ SITE, data = lobstah_body)

lobstah_sum <- summary(lobstah_aov)

lobstah_sum ## ANOVA Result: weak significance? (p=0.0354)

lobstah_ph <- TukeyHSD(lobstah_aov) #Tukey's post hoc

lobstah_ph ## Confirmed one significant difference between sizes at NAPL and IVEE
```



```{r}
#Create New data frame for MPA only data, and data only from 2012 and 2017
#Tables looked gross side by side, so made two and will 
MPA12 <- lobstar_abs_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  mutate(PROTECTED = case_when(
    SITE == "IVEE" ~ "MPA",
    SITE == "NAPL" ~ "MPA",
    SITE == "AQUE" ~ "Non-MPA",
    SITE == "CARP" ~ "Non-MPA",
    SITE == "MOHK" ~ "Non-MPA"))

MPA_Graph_12 <- ggplot(MPA12, aes(x= SITE, y= SIZE))+
  geom_boxplot(aes(fill = PROTECTED))+
  facet_wrap(~ YEAR)+
  theme_classic()+
  scale_x_discrete(limits = c("AQUE", "CARP", "MOHK", "IVEE", "NAPL"))+
  ylab("Carapice Length")


MPA_Graph_12 + theme(panel.spacing = unit(3, "lines"))

## Testing differences in means between carapace length in protected and non-protected sites

##H0: There is no difference in carapace lengths between protected and non-protected sites
##HA: There is a difference in carapace lenths between protected and nonprotected sites

##2012
mpa12_protected <- MPA12 %>%
  filter(PROTECTED == "MPA") %>%
  filter(YEAR == "2012")
      
mpa12_unprotected <- MPA12 %>%
  filter(PROTECTED == "Non-MPA") %>%
  filter(YEAR == "2012")

mpa12_t <- t.test(mpa12_protected$SIZE, mpa12_unprotected$SIZE)

mpa12_t ## p = 0.1806


##2017
mpa17_protected <- MPA12 %>%
  filter(PROTECTED == "MPA") %>%
  filter(YEAR == "2017")
      
mpa17_unprotected <- MPA12 %>%
  filter(PROTECTED == "Non-MPA") %>%
  filter(YEAR == "2017")

mpa17_t <- t.test(mpa17_protected$SIZE, mpa17_unprotected$SIZE)

mpa17_t

## Between years

comp_t <- t.test(mpa12_protected$SIZE, mpa17_protected$SIZE)

comp_t


```

